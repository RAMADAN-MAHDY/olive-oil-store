<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† - Ø²ÙŠØª Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="font-Cairo bg-[#f8f9fa] text-gray-800 antialiased min-h-screen">
    <header class="bg-gradient-to-r from-[#6b7c32] to-[#8ba446] text-white py-4 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="text-2xl font-extrabold flex items-center gap-2">
                ğŸ«’ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†
            </div>
            <a href="index.html" class="bg-white text-[#6b7c32] font-bold px-6 py-2 rounded-full shadow hover:bg-[#f4d03f] hover:text-[#2c3e30] transition">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</a>
        </div>
    </header>
    <main class="container mx-auto px-2 md:px-4 py-6 md:py-10">
        <h1 class="text-2xl md:text-3xl font-bold mb-6 md:mb-8 text-[#6b7c32] text-center md:text-right">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        <div class="flex flex-col md:flex-row gap-4 md:gap-8">
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div id="users-list" class="bg-white rounded-lg shadow-lg p-3 md:p-4 md:w-1/3 w-full max-h-[400px] md:max-h-[600px] overflow-y-auto mb-4 md:mb-0">
                <div class="text-center text-gray-500 py-8">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>
            </div>
            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
            <div id="user-orders" class="bg-white rounded-lg shadow-lg p-3 md:p-4 flex-1 min-h-[220px] md:min-h-[300px] overflow-x-auto">
                <div class="text-center text-gray-400 py-8">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙ‡</div>
            </div>
        </div>
    </main>
    <style>
        @media (max-width: 768px) {
          #user-orders table {
            font-size: 13px;
          }
          #user-orders th, #user-orders td {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
          }
        }
        #user-orders table {
          min-width: 700px;
        }
    </style>
    <script>
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
        async function checkAdmin() {
            try {
                const res = await fetch('http://localhost:5000/api/user/check', { credentials: 'include' });
                if (!res.ok) throw new Error();
                const data = await res.json();
                if (!data.user || !data.user.isAdmin) throw new Error();
            } catch {
                alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.');
                window.location.href = 'index.html';
            }
        }
        checkAdmin();

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        async function loadAdminUsers() {
            const usersList = document.getElementById('users-list');
            const userOrders = document.getElementById('user-orders');
            usersList.innerHTML = '<div class="text-center text-gray-500 py-8">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>';
            try {
                const res = await fetch('http://localhost:5000/api/order/admin/users', { credentials: 'include' });
                const users = await res.json();
                if (Array.isArray(users) && users.length > 0) {
                    usersList.innerHTML = users.map((u, i) => `
                        <div class="user-item cursor-pointer p-3 rounded-lg mb-2 flex flex-col gap-1 border hover:bg-[#f8f9fa] ${i===0?'bg-[#e9ecef]':''}" data-index="${i}">
                            <div class="font-bold text-[#6b7c32]">${u.name}</div>
                            <div class="text-xs text-gray-500">${u.email}</div>
                            <div class="text-xs text-gray-700">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <span class="font-bold">${u.orders.length}</span></div>
                        </div>
                    `).join('');
                    // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                    renderUserOrders(users[0]);
                    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    document.querySelectorAll('.user-item').forEach(item => {
                        item.onclick = function () {
                            document.querySelectorAll('.user-item').forEach(i => i.classList.remove('bg-[#e9ecef]'));
                            this.classList.add('bg-[#e9ecef]');
                            const idx = +this.getAttribute('data-index');
                            renderUserOrders(users[idx]);
                        };
                    });
                } else {
                    usersList.innerHTML = '<div class="text-center text-gray-500 py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ø¹Ø¯.</div>';
                    userOrders.innerHTML = '<div class="text-center text-gray-400 py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
                }
            } catch {
                usersList.innerHTML = '<div class="text-center text-red-500 py-8">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</div>';
                userOrders.innerHTML = '<div class="text-center text-red-400 py-8">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</div>';
            }
        }
        // Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…
        function renderUserOrders(user) {
            const userOrders = document.getElementById('user-orders');
            if (!user.orders.length) {
                userOrders.innerHTML = `<div class='text-center text-gray-400 py-8'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</div>`;
                return;
            }
            let table = `<div class='mb-4'><span class='font-bold text-[#6b7c32]'>${user.name}</span> - <span class='text-xs text-gray-500'>${user.email}</span></div>`;
            table += `<table class="min-w-full text-sm text-right rtl:text-right">
                <thead class="bg-[#f4d03f] text-[#2c3e30]">
                    <tr>
                        <th class="py-2 px-3">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th class="py-2 px-3">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                        <th class="py-2 px-3">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
                        <th class="py-2 px-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
                        <th class="py-2 px-3">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th class="py-2 px-3">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="py-2 px-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th class="py-2 px-3">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th class="py-2 px-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                    </tr>
                </thead>
                <tbody>`;
            table += user.orders.map(order => `
                <tr class="border-b hover:bg-[#f8f9fa]">
                    <td class="py-2 px-3 font-mono">${order._id.slice(-6).toUpperCase()}</td>
                    <td class="py-2 px-3">${order.address}</td>
                    <td class="py-2 px-3">${order.city}</td>
                    <td class="py-2 px-3">${order.phone || '-'}</td>
                    <td class="py-2 px-3">${order.quantity}</td>
                    <td class="py-2 px-3">${order.price} Ø¬</td>
                    <td class="py-2 px-3"><span class="px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status || 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}</span></td>
                    <td class="py-2 px-3">
                        <select class="status-select border rounded px-2 py-1" data-id="${order._id}">
                            <option value="ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„" ${order.status === 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</option>
                            <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²" ${order.status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²' ? 'selected' : ''}>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
                            <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„" ${order.status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„' ? 'selected' : ''}>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                            <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ${order.status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' || order.status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' ? 'selected' : ''}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                        </select>
                    </td>
                    <td class="py-2 px-3 text-xs">${new Date(order.createdAt).toLocaleDateString('ar-EG')}</td>
                </tr>
            `).join('');
            table += '</tbody></table>';
            userOrders.innerHTML = table;
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
            document.querySelectorAll('.status-select').forEach(sel => {
                sel.addEventListener('change', async function () {
                    const orderId = this.getAttribute('data-id');
                    const newStatus = this.value;
                    this.disabled = true;
                    try {
                        const res = await fetch(`http://localhost:5000/api/order/${orderId}/status`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ status: newStatus })
                        });
                        if (res.ok) {
                            this.classList.add('bg-green-100');
                            setTimeout(() => this.classList.remove('bg-green-100'), 1000);
                            loadAdminUsers();
                        } else {
                            alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.');
                        }
                    } catch {
                        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
                    } finally {
                        this.disabled = false;
                    }
                });
            });
        }
        function getStatusColor(status) {
            if (status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' || status === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') return 'bg-green-100 text-green-700';
            if (status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„') return 'bg-yellow-100 text-yellow-700';
            if (status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²') return 'bg-blue-100 text-blue-700';
            return 'bg-gray-200 text-gray-700';
        }
        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        loadAdminUsers();
    </script>
</body>
</html>
